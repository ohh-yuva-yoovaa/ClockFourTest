<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../../../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../../../jacoco-resources/report.gif" type="image/gif"/><title>TestService.java</title><link rel="stylesheet" href="../../../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../../../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../../../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../../../index.html" class="el_report">ServiceTest (Jan 11, 2019 4:55:17 PM)</a> &gt; <a href="../../index.html" class="el_group">ClockFourTest</a> &gt; <a href="../index.html" class="el_bundle">src/main/java</a> &gt; <a href="index.source.html" class="el_package">com.clockfour.service</a> &gt; <span class="el_source">TestService.java</span></div><h1>TestService.java</h1><pre class="source lang-java linenums">package com.clockfour.service;

import static java.nio.file.StandardCopyOption.REPLACE_EXISTING;

import java.io.File;
import java.io.FileOutputStream;
import java.io.FileWriter;
import java.io.IOException;
import java.io.PrintWriter;
import java.nio.file.Files;
import java.nio.file.Path;
import java.nio.file.Paths;
import java.util.concurrent.FutureTask;

import org.apache.log4j.Logger;
import org.apache.poi.hssf.usermodel.HSSFWorkbook;
import org.apache.poi.ss.usermodel.Cell;
import org.apache.poi.ss.usermodel.CellStyle;
import org.apache.poi.ss.usermodel.CreationHelper;
import org.apache.poi.ss.usermodel.Font;
import org.apache.poi.ss.usermodel.IndexedColors;
import org.apache.poi.ss.usermodel.Row;
import org.apache.poi.ss.usermodel.Sheet;
import org.apache.poi.ss.usermodel.Workbook;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.stereotype.Service;
import org.springframework.web.multipart.MultipartFile;

import com.clockfour.model.Employee;
import com.clockfour.model.EmployeesHolder;
import com.clockfour.model.Response;

@Service(&quot;TestService&quot;)
<span class="fc" id="L34">public class TestService {</span>
	
<span class="fc" id="L36">	static final Logger log = Logger.getLogger(TestService.class);</span>

	@Value(&quot;${image.folder}&quot;)
	private String imageFolder;

	@Value(&quot;${archive.folder}&quot;)
	private String archiveFolder;

	@Value(&quot;${xls.name}&quot;)
	private String xlsName;
	
	@Value(&quot;${output.file}&quot;)
	private String outputFile;
	
<span class="fc" id="L50">    private static String[] xlColumns = {&quot;First Name&quot;, &quot;Last Name&quot;, &quot;DOB&quot;};</span>

	public Response process(MultipartFile image, EmployeesHolder employees) {
<span class="fc" id="L53">		Response response = new Response();</span>
<span class="fc" id="L54">		log.info(&quot;Initiating process&quot;);</span>
<span class="pc bpc" id="L55" title="3 of 6 branches missed.">		if (image!= null &amp;&amp; !image.isEmpty() &amp;&amp; processImage(image)) {</span>
<span class="fc" id="L56">			response.setImageName(image.getOriginalFilename());</span>
<span class="fc" id="L57">			response.setImageFileSize(image.getSize());</span>
<span class="fc" id="L58">			log.info(&quot;Image processing successful:&quot; + response);</span>
		}
<span class="pc bpc" id="L60" title="1 of 2 branches missed.">		if (processEmployees(employees)) {</span>
<span class="fc" id="L61">			response.setEmployees(employees.getEmployees());</span>
<span class="fc" id="L62">			log.info(&quot;Employees processing successful:&quot; + response);</span>
		}
		
<span class="fc" id="L65">		return response;</span>
	}

	public boolean processImage(MultipartFile image) {
        try {
<span class="fc" id="L70">            Path path = Paths.get(imageFolder + File.separator + image.getOriginalFilename());</span>
<span class="pc bpc" id="L71" title="1 of 2 branches missed.">            if(path.toFile().exists()) {</span>
<span class="fc" id="L72">            	log.info(&quot;Image file with same name exists, archiving&quot;);</span>
<span class="fc" id="L73">            	Path archive = Paths.get(archiveFolder + File.separator + image.getOriginalFilename() + &quot;.&quot; + System.currentTimeMillis());</span>
<span class="fc" id="L74">            	Files.move(path, archive, REPLACE_EXISTING);</span>
<span class="fc" id="L75">            	log.info(&quot;Image file with same name archived&quot;);</span>
            }
<span class="fc" id="L77">            Files.write(path, image.getBytes());</span>
<span class="fc" id="L78">        	log.info(&quot;Image file saved&quot;);</span>
<span class="pc" id="L79">        } catch (Exception e) {</span>
<span class="nc" id="L80">            log.info(e);</span>
<span class="nc" id="L81">            return false;</span>
        }
<span class="fc" id="L83">		return true;</span>
	}

	public boolean processEmployees(EmployeesHolder employees) {
<span class="fc" id="L87">    	log.info(&quot;Starting employee processing&quot;);</span>

<span class="fc" id="L89">		FutureTask&lt;Boolean&gt; ft1 = new FutureTask&lt;&gt;(() -&gt; writeExcel(employees));</span>
<span class="fc" id="L90">		FutureTask&lt;Boolean&gt; ft2 = new FutureTask&lt;&gt;(() -&gt; writePDF(employees));</span>
		 	 
<span class="fc" id="L92">    	new Thread(ft1).start();</span>
<span class="fc" id="L93">    	log.info(&quot;Excel generation started&quot;);</span>
<span class="fc" id="L94">		new Thread(ft2).start();</span>
<span class="fc" id="L95">    	log.info(&quot;PDF generation started&quot;);</span>
		
		try {
<span class="pc bpc" id="L98" title="2 of 4 branches missed.">			if(ft1.get() &amp;&amp; ft2.get()) {</span>
<span class="fc" id="L99">		    	log.info(&quot;Excel &amp; PDF generation completed&quot;);</span>
<span class="fc" id="L100">				return true;</span>
			}
<span class="nc" id="L102">		} catch (Exception e) {</span>
<span class="nc" id="L103">			log.error(e);</span>
<span class="nc" id="L104">			return false;</span>
		}

<span class="nc" id="L107">    	log.info(&quot;Excel &amp; PDF generation failed&quot;);</span>
<span class="nc" id="L108">		return false;</span>
	}

	public boolean writePDF(EmployeesHolder employees) {
		PrintWriter pw;
		try {
<span class="fc" id="L114">			pw = new PrintWriter(new FileWriter(outputFile));</span>
<span class="fc" id="L115">			pw.println(String.join(&quot;|&quot;, xlColumns));</span>
<span class="fc bfc" id="L116" title="All 2 branches covered.">	        for(Employee employee: employees.getEmployees()) {</span>
<span class="fc" id="L117">	        	pw.println(employee.toPDString());</span>
	        }
<span class="fc" id="L119">	        pw.close();</span>
<span class="pc" id="L120">		} catch (IOException e) {</span>
<span class="nc" id="L121">			log.error(e);</span>
<span class="nc" id="L122">			return false;</span>
		}
<span class="fc" id="L124">        return true;		</span>
	}
	
	// Used https://www.callicoder.com/java-write-excel-file-apache-poi/
	public boolean writeExcel(EmployeesHolder employees) {
		// Write the output to a file
<span class="fc" id="L130">		try (FileOutputStream fileOut = new FileOutputStream(xlsName); Workbook workbook = new HSSFWorkbook();) {</span>
<span class="fc" id="L131">			CreationHelper createHelper = workbook.getCreationHelper();</span>

			// Create a Sheet
<span class="fc" id="L134">			Sheet sheet = workbook.createSheet(&quot;Employees&quot;);</span>

			// Create a Font for styling header cells
<span class="fc" id="L137">			Font headerFont = workbook.createFont();</span>
<span class="fc" id="L138">			headerFont.setBold(true);</span>
<span class="fc" id="L139">			headerFont.setFontHeightInPoints((short) 12);</span>
<span class="fc" id="L140">			headerFont.setColor(IndexedColors.BLACK.getIndex());</span>

			// Create a CellStyle with the font
<span class="fc" id="L143">			CellStyle headerCellStyle = workbook.createCellStyle();</span>
<span class="fc" id="L144">			headerCellStyle.setFont(headerFont);</span>

			// Create a Row
<span class="fc" id="L147">			Row headerRow = sheet.createRow(0);</span>

			// Create cells
<span class="fc bfc" id="L150" title="All 2 branches covered.">			for (int i = 0; i &lt; xlColumns.length; i++) {</span>
<span class="fc" id="L151">				Cell cell = headerRow.createCell(i);</span>
<span class="fc" id="L152">				cell.setCellValue(xlColumns[i]);</span>
<span class="fc" id="L153">				cell.setCellStyle(headerCellStyle);</span>
			}

			// Create Cell Style for formatting Date
<span class="fc" id="L157">			CellStyle dateCellStyle = workbook.createCellStyle();</span>
<span class="fc" id="L158">			dateCellStyle.setDataFormat(createHelper.createDataFormat().getFormat(&quot;MM/dd/yyyy&quot;));</span>

			// Create Other rows and cells with employees data
<span class="fc" id="L161">			int rowNum = 1;</span>
<span class="fc bfc" id="L162" title="All 2 branches covered.">			for (Employee employee : employees.getEmployees()) {</span>
<span class="fc" id="L163">				Row row = sheet.createRow(rowNum++);</span>

<span class="fc" id="L165">				row.createCell(0).setCellValue(employee.getFirstname());</span>
<span class="fc" id="L166">				row.createCell(1).setCellValue(employee.getLastname());</span>
<span class="fc" id="L167">				Cell dateOfBirthCell = row.createCell(2);</span>
<span class="fc" id="L168">				dateOfBirthCell.setCellValue(employee.getDob());</span>
<span class="fc" id="L169">				dateOfBirthCell.setCellStyle(dateCellStyle);</span>
			}

			// Resize all columns to fit the content size
<span class="fc bfc" id="L173" title="All 2 branches covered.">			for (int i = 0; i &lt; xlColumns.length; i++) {</span>
<span class="fc" id="L174">				sheet.autoSizeColumn(i);</span>
			}

<span class="fc" id="L177">			workbook.write(fileOut);</span>
<span class="nc" id="L178">		} catch (IOException e) {</span>
<span class="nc" id="L179">			log.error(e);</span>
<span class="nc" id="L180">			return false;</span>
		}
<span class="fc" id="L182">		return true;</span>
	}
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.2.201808211720</span>ServiceTest (Jan 11, 2019 4:55:17 PM)</div></body></html>